#!/usr/bin/env python
from os import listdir, statvfs
from collections import namedtuple

Entry = namedtuple('Entry', 'size pid ppid name'.split())

entries = {}

for p in listdir('/proc'):
	try: p = int(p)
	except: continue

	try:
		name = None
		ppid = None
		with open('/proc/%d/status' % p) as f:
			for line in f:
				if line.startswith('Name:\t'):
					name = line[6:].rstrip('\n')
					continue
				if line.startswith('PPid:\t'):
					ppid = int(line[6:].rstrip('\n'))
					continue

		n = 0
		with open('/proc/%d/smaps' % p) as f:
			for line in f:
				line = line.split()
				if line[0] in ('Pss:', 'SwapPss:'):
					n += int(line[1])
	except FileNotFoundError:
		continue
	entries[p] = Entry(n, p, ppid, name)

with open('/proc/mounts') as f:
	for line in f:
		_, dst, type, _, _, _ = line.split()
		if type in ('tmpfs', 'devtmpfs'):
			s = statvfs(dst)
			n = (s.f_blocks - s.f_bfree) * s.f_bsize / 1024
			entries[dst] = Entry(n, None, 1, dst)

entries = list(entries.values())
entries.sort(key=lambda e: e.size)
for e in entries:
	print('%8.1f %s%s' % (e.size/1024, '% 6d ' % e.pid if e.pid else '       ', e.name))
